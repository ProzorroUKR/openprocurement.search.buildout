#!/bin/sh

BASEDIR=${buildout:directory}
CONFDIR=${buildout:etc-directory}
LOGSDIR=${buildout:log-directory}
CONTROL=$BASEDIR/bin/circusctl

cd $BASEDIR || exit 1

clean_indexes()
{
  for INI in $CONFDIR/search*.ini
  do
    $BASEDIR/bin/clean_indexes $INI >>$LOGSDIR/clean.log 2>&1
  done
}

do_restart_workers()
{
  echo "["`date`"] Restart search-tenders"
  $CONTROL stop
  while [ `$CONTROL status | grep -c -v stopped` -ne 0 ] ; do
    sleep 1
  done
  sleep 2
  $CONTROL start
}

restart_workers()
{
  do_restart_indexer >>$LOGSDIR/restart.log 2>&1
}

do_reload_workers()
{
  echo "["`date`"] Reload search-tenders"
  $CONTROL restart
  sleep 5
  if [ ! -s $PIDFILE -a -S $SOCKET ] ; then
    $CONTROL dstats | awk '$2~/python/{print $1}' >$PIDFILE
  fi
}

reload_workers()
{
  do_reload_workers >>$LOGSDIR/restart.log 2>&1
}

rotate_logs()
{
  if [ -x /usr/sbin/logrotate ] ; then
    /usr/sbin/logrotate $CONFDIR/logrotate.conf >/dev/null
  fi
}

ocds_ftp_sync()
{
  $BASEDIR/bin/ocds_ftp_sync $CONFDIR/ftpsync.ini >>$LOGSDIR/ftpsync.log 2>&1
}

update_orgs()
{
  for INI in $CONFDIR/search*.ini
  do
    $BASEDIR/bin/update_orgs $INI >>$LOGSDIR/update.log 2>&1
  done
}

test_search()
{
  for INI in $CONFDIR/search*.ini
  do
    $BASEDIR/bin/test_index $INI >>$LOGSDIR/test.log 2>&1
    $BASEDIR/bin/test_search $INI >>$LOGSDIR/test.log 2>&1
  done
}


case $1 in
clean)      clean_indexes   ;;
restart)    restart_workers ;;
reload)     reload_workers  ;;
ftpsync)    ocds_ftp_sync   ;;
update)     update_orgs     ;;
rotate)     rotate_logs     ;;
test)       test_search     ;;
*)  echo "Usage: $0 {clean|restart|reload|ftpsync|update|rotate|test}"
	exit 1
esac

